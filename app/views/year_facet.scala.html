@* Copyright 2015 Fabian Steeg, hbz. Licensed under the GPLv2 *@

@(filter: String)

<script>

var dateOfBirth = '@("dateOfBirth:\\[([^\\]]+?)\\]".r.findFirstIn(filter).getOrElse("").replace("dateOfBirth:",""))'
console.log("dateOfBirth: " + dateOfBirth)

$("#dateOfBirth-facet-text").hide();
$("#dateOfBirth-facet-all").show();

var years = [];
var freqs = [];
var yearsObject = {};
var thisYear = new Date().getFullYear();

var min = thisYear;
var max = 0;

$(".dateOfBirth-facet-link").each(function(index) {
	var yearAndFreq = $(this).text().split(" ")
	var year = parseInt(yearAndFreq[0].trim());
	var freq = parseInt(yearAndFreq[1].replace(/[()]/,""));
	if(year > 0 && year <= thisYear){
		yearsObject[year]=freq;
		max = Math.max(max, year);
		min = Math.min(min, year);
	}
});

for(i = min; i <= max; i++) {
	years.push(i);
}

if(years.length==0){
	yearsObject[thisYear]=0;
}

var chartYears = [];
for(i = min; i<=max; i++){
	chartYears.push(i);
	var y = yearsObject[i]
	freqs.push(y ? y : 0);
}

var data = {
	labels: chartYears,
	datasets: [{
		fillColor: "rgba(0, 70, 120, 0.2)",
		strokeColor: "rgba(0, 70, 120, 0.5)",
		highlightFill: "rgba(0, 70, 120, 0.45)",
		highlightStroke: "rgba(0, 70, 120, 0.7)",
		data: freqs
	}]
};

var options = {
	animation: false,
	scaleShowGridLines : false,
	barValueSpacing : 1,
	showScale: false,
	showTooltips: true,
	customTooltips: function(tooltip) {
		$( "#dateOfBirth-range" ).val(tooltip.text);
		return;
	},
	tooltipTemplate: "<%if (label){%><%=label%>: <%}%><%= value %> Treffer"
}

var canvas = document.getElementById("dateOfBirth-chart");
var ctx = canvas.getContext("2d");
var barChart = new Chart(ctx).Bar(data, options);

canvas.onclick = function(evt){
	var activeBars = barChart.getBarsAtEvent(evt);
	if(activeBars){
		var year = activeBars[0].label;
		var s = "dateOfBirth:[" + year + " TO " + (year+1) + '@Html("}")';
		location.href = dateOfBirthLink(s);
	}
};

var lastLabel = ""; // set in setLabel below

canvas.onmouseout = function(evt){
	$( "#dateOfBirth-range" ).val(lastLabel);
};

var elems = dateOfBirth.split(/[\[\] ]/);
console.log(elems);

var from = dateOfBirth ? elems[1] : "";
var to = dateOfBirth ? elems[3] : "";

$(function() {
	$( "#slider-range" ).slider({
		range: true,
		min: min,
		max: max,
		values: [from.length<=1 ? min : from, to.length<=1 ? max : to],
		slide: function( event, ui ) {
			var curFrom = ui.values[0];
			var curTo = ui.values[1];
			var hits = sumHits(curFrom, curTo);
			var fromTo = "dateOfBirth:[" + curFrom + " TO " + curTo + "]";
			setLabel(fromTo, hits);
			$("#dateOfBirth-link").attr("href", dateOfBirthLink(fromTo));
			$("#dateOfBirth-link").show();
		}
	});
	var left = $( "#slider-range" ).slider( "values", 0 );
	var right = $( "#slider-range" ).slider( "values", 1 );
	setLabel(left==right ? left : left + "-" + right, "");
});

function dateOfBirthLink(newVal) {
	var oldHref = $("#dateOfBirth-link").attr("href");
	var newDateOfBirth = "filter="+"@(filter)".replace("dateOfBirth:","").replace(dateOfBirth,newVal);
	var newHref = oldHref.indexOf("filter=") >= 0 ?
		oldHref.replace(/filter=[^&]+/, newDateOfBirth) :
		oldHref + (oldHref.indexOf("?") >= 0 ? "&" : "?") + newDateOfBirth;
	return newHref;
}

function setLabel(range, hits) {
	var label = range + (hits ? (": " + hits + " Treffer") : "");
	$("#dateOfBirth-range").val(label);
	lastLabel = label;
}

function sumHits(a, b) {
	var res = 0;
	for(i = a; i <= b; i++){
		res += yearsObject[i] ? yearsObject[i] : 0;
	}
	return res;
}

</script>